<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Drive.AI ‚Äî Asistente de voz</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#070b14; --bg2:#0a1224; --panel:#0f172a; --line:#1e2a41;
    --txt:#e6ecff; --muted:#a7b6d8; --pri:#5aa9ff; --accent:#22d3ee; --ok:#22c55e; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--txt);
    background:
      radial-gradient(80vmax 80vmax at -10% -10%, #0e1a3a 0%, transparent 60%),
      radial-gradient(70vmax 70vmax at 120% 10%, #081427 0%, transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;
  }

  /* Layout */
  .wrap{ width:min(980px, 96vw); display:grid; gap:16px }
  .top{ display:flex; align-items:center; justify-content:space-between }
  .brand{ display:flex; gap:10px; align-items:center; font-size:28px; font-weight:800; letter-spacing:.3px }
  .brand-badge{
    width:34px;height:34px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #fff, #9ad7ff 40%, transparent 60%);
    box-shadow:0 0 24px rgba(34,211,238,.32), inset 0 0 16px rgba(90,169,255,.28);
    display:grid;place-items:center
  }
  .pill{ font-size:12px; padding:6px 10px; border:1px solid #22324a; border-radius:999px; color:#cbd5e1; background:#0f1e33 }

  .grid{
    display:grid; grid-template-columns: 1fr 1fr; gap:16px;
  }
  @media (max-width:820px){ .grid{ grid-template-columns: 1fr; } }

  .card{
    background:linear-gradient(180deg, rgba(18,26,46,.72), rgba(12,18,34,.72));
    border:1px solid var(--line); border-radius:20px; padding:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
  }

  /* Assistant panel */
  .center{ display:grid; place-items:center; text-align:center; gap:14px; padding:16px 10px }
  .btn{
    background:linear-gradient(180deg, #3b82f6, #2563eb);
    border:1px solid #1b3f7a; color:#fff; padding:14px 20px; font-weight:700;
    border-radius:999px; cursor:pointer; transition:.12s ease;
    box-shadow:0 8px 24px rgba(37,99,235,.35), inset 0 0 0 1px rgba(255,255,255,.06);
  }
  .btn:active{ transform:translateY(1px) }
  .you, .assistant{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap }
  .assistant{ color:#bfe6ff }

  /* Jarvis widget */
  .jarvis{ position:relative; height:260px; display:grid; place-items:center }
  .j-core{
    position:relative; width:180px; height:180px; border-radius:50%;
    background:
      radial-gradient(120px 120px at 50% 50%, rgba(34,211,238,.18), transparent 60%),
      radial-gradient(90px 90px at 50% 50%, rgba(96,165,250,.16), transparent 70%),
      #081225;
    box-shadow:0 0 42px rgba(34,211,238,.18), inset 0 0 30px rgba(96,165,250,.15);
  }
  .j-ring{
    position:absolute; inset:-18px; border-radius:50%;
    background:conic-gradient(from 0deg, rgba(90,169,255,.38), rgba(167,139,250,.45), rgba(34,211,238,.38), rgba(90,169,255,.38));
    -webkit-mask:radial-gradient(farthest-side, transparent calc(100% - 10px), #000 0);
            mask:radial-gradient(farthest-side, transparent calc(100% - 10px), #000 0);
    filter:drop-shadow(0 0 10px rgba(34,211,238,.35));
    animation:rot 6s linear infinite paused;
  }
  .j-dash{ position:absolute; inset:-38px; border-radius:50%; border:2px dashed rgba(99,102,241,.35); animation:rot 16s linear infinite paused }
  .j-pulse, .j-pulse::after{ position:absolute; inset:0; border-radius:50%; box-shadow:0 0 0 0 rgba(34,211,238,.34); animation:pulse 2.2s ease-out infinite paused }
  .j-pulse::after{ content:""; animation-delay:.8s }
  .j-orbit{ position:absolute; inset:-64px; animation:rot 10s linear infinite paused }
  .j-dot{ position:absolute; top:50%; left:0; transform:translate(-6px,-50%); width:8px; height:8px; border-radius:50%;
          background:radial-gradient(circle at 30% 30%, #fff, #9bf0ff 60%, transparent 70%);
          filter:blur(.2px) drop-shadow(0 0 6px rgba(110,231,255,.65)); }
  .j-dot:nth-child(2){ left:auto; right:0; transform:translate(6px,-50%) }
  .j-dot:nth-child(3){ top:auto; bottom:0; left:50%; transform:translate(-50%,6px) }
  .j-dot:nth-child(4){ top:0; left:50%; transform:translate(-50%,-6px) }
  .j-eq{ position:absolute; bottom:-24px; left:50%; transform:translateX(-50%); display:flex; gap:4px }
  .j-bar{ width:6px; height:10px; border-radius:8px; background:linear-gradient(180deg, var(--accent), var(--pri));
          opacity:.85; box-shadow:0 0 12px rgba(34,211,238,.45); transition:height .12s ease; }
  .speaking .j-ring, .speaking .j-dash, .speaking .j-orbit, .speaking .j-pulse{ animation-play-state:running }
  .speaking .j-core{ box-shadow:0 0 58px rgba(34,211,238,.32), inset 0 0 38px rgba(96,165,250,.24) }
  @keyframes rot{ to{ transform:rotate(360deg) } }
  @keyframes pulse{ 0%{box-shadow:0 0 0 0 rgba(34,211,238,.34)} 70%{box-shadow:0 0 0 22px rgba(34,211,238,0)} 100%{box-shadow:0 0 0 0 rgba(34,211,238,0)} }

  /* Driving HUD */
  .hud{ display:grid; gap:12px; padding:6px }
  .hud .row{ display:flex; align-items:center; justify-content:space-between; gap:10px;
             background:#0c162c; border:1px solid #16223a; border-radius:14px; padding:12px 14px; }
  .hud .title{ color:#cfe3ff; font-weight:700; letter-spacing:.2px }
  .hud .value{ color:#9fd9ff; font-weight:600 }
  .hud .btn-mini{ border:1px solid #22324a; background:#0f1e33; color:#cbd5e1; border-radius:10px; padding:6px 10px; cursor:pointer }
  .ok{ color:var(--ok) } .bad{ color:#fecaca }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="brand-badge">üéôÔ∏è</span>Drive.AI</div>
      <div class="pill" id="appStatus">Listo</div>
    </div>

    <div class="grid">
      <!-- Assistant panel -->
      <section class="card center">
        <div id="jarvis" class="jarvis">
          <div class="j-core">
            <div class="j-ring"></div><div class="j-dash"></div><div class="j-pulse"></div>
            <div class="j-orbit"><span class="j-dot"></span><span class="j-dot"></span><span class="j-dot"></span><span class="j-dot"></span></div>
            <div class="j-eq" id="jEq"></div>
          </div>
        </div>

        <p id="you" class="you"></p>
        <p id="assistant" class="assistant"></p>

        <button id="speakBtn" class="btn">Hablar</button>
        <div id="status" class="pill" style="margin-top:6px">En espera</div>
      </section>

      <!-- Driving HUD -->
      <section class="card hud">
        <div class="row">
          <div>
            <div class="title">Ubicaci√≥n</div>
            <div class="value" id="hudPlace">‚Äî</div>
          </div>
          <button id="locBtn" class="btn-mini">Actualizar</button>
        </div>

        <div class="row">
          <div>
            <div class="title">Clima actual</div>
            <div class="value"><span id="hudTemp">‚Äî</span> ¬∑ <span id="hudCond">‚Äî</span></div>
          </div>
          <div class="pill" id="hudUnits">¬∞C</div>
        </div>

        <div class="row">
          <div>
            <div class="title">Estado</div>
            <div class="value" id="hudStatus">Listo</div>
          </div>
          <div id="hudSignal" class="ok">‚óè</div>
        </div>
      </section>
    </div>
  </div>

<script>
/* ===== Jarvis visualizer ===== */
class JarvisViz {
  constructor(root){
    this.root = root; this.eq = document.getElementById('jEq'); this.timer=null; this.bars=[];
    for(let i=0;i<16;i++){ const b=document.createElement('div'); b.className='j-bar'; this.eq.appendChild(b); this.bars.push(b); }
  }
  start(){ if(this.timer) return; this.root.classList.add('speaking'); let t=0; this.timer=setInterval(()=>{ t+=0.12; for(let i=0;i<this.bars.length;i++){ const h=10+Math.abs(Math.sin(t*(0.85+i*0.035))*28)+(Math.random()*18); this.bars[i].style.height=`${Math.min(72,h)}px`; }},60); }
  stop(){ if(!this.timer) return; clearInterval(this.timer); this.timer=null; this.root.classList.remove('speaking'); this.bars.forEach(b=>b.style.height='10px'); }
}
const jarvis = new JarvisViz(document.getElementById('jarvis'));

/* ===== Refs ===== */
const appStatus = document.getElementById('appStatus');
const statusEl = document.getElementById('status');
const youEl = document.getElementById('you');
const assistantEl = document.getElementById('assistant');
const speakBtn = document.getElementById('speakBtn');

const hudPlace = document.getElementById('hudPlace');
const hudTemp  = document.getElementById('hudTemp');
const hudCond  = document.getElementById('hudCond');
const hudUnits = document.getElementById('hudUnits');
const hudStatus= document.getElementById('hudStatus');
const hudSignal= document.getElementById('hudSignal');

/* ===== STT ===== */
const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recog = new Recognition();
recog.lang = "es-AR";
recog.interimResults = false;

speakBtn.onclick = () => {
  recog.start();
  statusEl.textContent = "üéß Escuchando‚Ä¶";
  appStatus.textContent = "Escuchando‚Ä¶";
  jarvis.start();
};

recog.onend = () => { if(!speechSynthesis.speaking) jarvis.stop(); };
recog.onerror = () => { statusEl.textContent="‚ö†Ô∏è Error de micr√≥fono"; appStatus.textContent="Micr√≥fono"; hudSignal.className="bad" };

/* ===== TTS (con animaci√≥n) ===== */
function ttsJarvis(text, opts={}){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = opts.lang || "es-AR";
  u.onstart = ()=>{ jarvis.start(); appStatus.textContent="Hablando" };
  u.onend   = ()=>{ jarvis.stop();  appStatus.textContent="Listo" };
  speechSynthesis.speak(u);
}

/* ===== Utilidades de clima/ubicaci√≥n ===== */
let lastWeather = null; // cache simple
async function getLocation(){
  hudStatus.textContent = "Buscando ubicaci√≥n‚Ä¶";
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("Sin geolocalizaci√≥n"));
    navigator.geolocation.getCurrentPosition(
      pos=>resolve({lat:pos.coords.latitude, lon:pos.coords.longitude}),
      err=>reject(err), { enableHighAccuracy:true, timeout:10000, maximumAge:60000 }
    );
  });
}
async function fetchWeather(lat, lon){
  // Open-Meteo: sin API key
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
  const r = await fetch(url); const data = await r.json();
  const cw = data?.current_weather;
  let cond = "Despejado";
  const code = cw?.weathercode;
  if(code!=null){
    if([0].includes(code)) cond="Despejado";
    else if([1,2,3].includes(code)) cond="Parcialmente nublado";
    else if([45,48].includes(code)) cond="Niebla";
    else if([51,53,55,56,57].includes(code)) cond="Llovizna";
    else if([61,63,65,66,67,80,81,82].includes(code)) cond="Lluvia";
    else if([71,73,75,77,85,86].includes(code)) cond="Nieve";
    else if([95,96,99].includes(code)) cond="Tormenta";
  }
  return { temp: Math.round(cw?.temperature ?? 0), cond };
}
async function reverseGeocode(lat, lon){
  const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=es`;
  const r = await fetch(url); const data = await r.json(); const p = data?.results?.[0];
  return p ? `${p.name}${p.admin1 ? ', '+p.admin1 : ''}` : `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
}
async function updateHUD(){
  try{
    hudSignal.className="ok";
    const {lat, lon} = await getLocation();
    const [place, w] = await Promise.all([reverseGeocode(lat,lon), fetchWeather(lat,lon)]);
    lastWeather = { place, ...w };
    hudPlace.textContent = place;
    hudTemp.textContent  = `${w.temp}¬∞`;
    hudCond.textContent  = w.cond;
    hudStatus.textContent= "Listo";
  }catch(e){
    hudStatus.textContent = "Sin permisos de ubicaci√≥n";
    hudSignal.className="bad";
  }
}
document.getElementById('locBtn').onclick = updateHUD;
// carga inicial
updateHUD();

/* ===== Intents locales (hora/fecha/clima/ubicaci√≥n) ===== */
function maybeLocalIntent(text){
  const t = (text||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
  // Hora
  if (/(^|\s)(que|qu√©)?\s*hora(\s*es)?(\s|$)/.test(t) || t.includes('decime la hora') || t.includes('dime la hora')) {
    const h = new Date().toLocaleTimeString('es-AR', { hour:'2-digit', minute:'2-digit' });
    const reply = `Son las ${h}.`;
    assistantEl.textContent = reply; statusEl.textContent="‚úÖ Hecho"; ttsJarvis(reply); return true;
  }
  // Fecha
  if (t.includes('que dia es') || t.includes('qu√© dia es') || t.includes('que fecha es') || t.includes('fecha de hoy')) {
    const f = new Date().toLocaleDateString('es-AR',{weekday:'long', day:'numeric', month:'long'});
    const reply = `Hoy es ${f}.`;
    assistantEl.textContent = reply; statusEl.textContent="‚úÖ Hecho"; ttsJarvis(reply); return true;
  }
  // Clima
  if (t.includes('clima') || t.includes('temperatura') || t.includes('tiempo')) {
    if(lastWeather){
      const reply = `${lastWeather.place}: ${lastWeather.temp} grados, ${lastWeather.cond}.`;
      assistantEl.textContent = reply; statusEl.textContent="‚úÖ Hecho"; ttsJarvis(reply);
    } else {
      assistantEl.textContent = "Actualizo el clima‚Ä¶"; ttsJarvis("Actualizo el clima"); updateHUD();
    }
    return true;
  }
  // Ubicaci√≥n
  if (t.includes('donde estoy') || t.includes('d√≥nde estoy') || t.includes('ubicacion') || t.includes('ubicaci√≥n')) {
    if(lastWeather){
      const reply = `Est√°s cerca de ${lastWeather.place}.`;
      assistantEl.textContent = reply; statusEl.textContent="‚úÖ Hecho"; ttsJarvis(reply);
    } else {
      assistantEl.textContent = "Necesito tu ubicaci√≥n. Toc√° actualizar."; ttsJarvis("Necesito tu ubicaci√≥n. Toc√° actualizar.");
    }
    return true;
  }
  return false;
}

/* ===== Main flow ===== */
recog.onresult = async (e) => {
  const text = e.results[0][0].transcript;
  youEl.textContent = text;
  statusEl.textContent = "‚è≥ Procesando‚Ä¶";

  if (maybeLocalIntent(text)) return;

  try{
    const r = await fetch("/api/intent", {
      method: "POST", headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ text })
    });
    const data = await r.json();
    const reply = data.reply || "Listo.";
    assistantEl.textContent = reply;
    ttsJarvis(reply);
    statusEl.textContent = "‚úÖ Hecho";
    // Si la IA dice algo como ‚Äúte muestro el clima‚Äù, refrescamos HUD
    if (/clima|tiempo|temperatura/i.test(text)) updateHUD();
  }catch(err){
    console.error(err);
    const reply = "Hubo un problema conectando con la IA.";
    assistantEl.textContent = reply; statusEl.textContent="‚ö†Ô∏è Error"; ttsJarvis(reply);
  }
};
</script>
</body>
</html>
