<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SmartDrive — Asistente de voz</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#070b14; --bg2:#0a1224; --panel:#0f172a; --line:#1e2a41;
    --txt:#e6ecff; --muted:#9fb1d8; --neo:#5fd1ff; --neo2:#6af0e7; --warn:#ffd166; --ok:#22c55e; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    background:
      radial-gradient(70vmax 70vmax at 120% -10%, #0c1731 0%, transparent 60%),
      radial-gradient(60vmax 60vmax at -20% 0%, #081427 0%, transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
  }

  /* Mobile-first vertical layout */
  .wrap{min-height:100%; display:flex; flex-direction:column; padding: max(16px, env(safe-area-inset-top)) 16px 16px}
  header{display:flex; align-items:center; justify-content:space-between}
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px}
  .pill{font-size:12px; padding:6px 10px; border:1px solid #22324a; border-radius:999px; color:#cbd5e1; background:#0f1e33}
  .clock{font-variant-numeric:tabular-nums; color:#cfe3ff}

  /* gear (only when not driving) */
  .gear{
    width:32px;height:32px;border-radius:10px; display:grid;place-items:center;
    border:1px solid #1e2a41; color:#90c9ff; background:#0b152a; opacity:.65; cursor:pointer;
    transition:transform .08s ease, opacity .2s ease, box-shadow .2s ease;
    box-shadow:0 0 0 0 rgba(95,209,255,.0);
  }
  .gear:active{ transform:scale(.96) }
  .gear.hidden{ display:none }

  /* Driving screen */
  .drive{
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px;
    text-align:center; padding:18px 10px; flex:1;
  }
  .status{ color:var(--muted); font-size:14px }
  .prompt{ font-size: clamp(22px, 6vw, 34px); line-height:1.15; letter-spacing:.2px; color:#dff1ff }

  /* Jarvis widget (tap to talk) */
  .jarvis{ position:relative; width:min(78vw,340px); aspect-ratio:1; display:grid; place-items:center; }
  .j-core{
    position:relative; width:68%; aspect-ratio:1; border-radius:50%;
    background:
      radial-gradient(60% 60% at 50% 50%, rgba(111,225,255,.18), transparent 60%),
      radial-gradient(45% 45% at 50% 50%, rgba(120,160,255,.16), transparent 70%),
      #081225;
    box-shadow:0 0 42px rgba(111,225,255,.22), inset 0 0 26px rgba(120,160,255,.18);
  }
  .j-ring{
    position:absolute; inset: -24px; border-radius:50%;
    background:conic-gradient(from 0deg, rgba(95,209,255,.5), rgba(170,140,255,.55), rgba(106,240,231,.5), rgba(95,209,255,.5));
    -webkit-mask:radial-gradient(farthest-side, transparent calc(100% - 12px), #000 0);
            mask:radial-gradient(farthest-side, transparent calc(100% - 12px), #000 0);
    filter:drop-shadow(0 0 12px rgba(95,209,255,.45));
    animation:rot 6s linear infinite paused;
  }
  .j-pulse, .j-pulse::after{ position:absolute; inset:0; border-radius:50%; box-shadow:0 0 0 0 rgba(106,240,231,.32); animation:pulse 2.2s ease-out infinite paused }
  .j-pulse::after{ content:""; animation-delay:.8s }
  .j-eq{ position:absolute; bottom:-24px; left:50%; transform:translateX(-50%); display:flex; gap:4px }
  .j-bar{ width:6px; height:10px; border-radius:8px; background:linear-gradient(180deg, var(--neo2), var(--neo));
          box-shadow:0 0 12px rgba(95,209,255,.45); transition:height .12s ease; opacity:.85 }

  .speaking .j-ring, .speaking .j-pulse{ animation-play-state:running }
  .speaking .j-core{ box-shadow:0 0 58px rgba(106,240,231,.35), inset 0 0 38px rgba(120,160,255,.24) }
  @keyframes rot{ to{ transform:rotate(360deg) } }
  @keyframes pulse{ 0%{box-shadow:0 0 0 0 rgba(106,240,231,.32)} 70%{box-shadow:0 0 0 22px rgba(106,240,231,0)} 100%{box-shadow:0 0 0 0 rgba(106,240,231,0)} }

  /* Footer mini status */
  .foot{ display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-top:auto; color:#a9c6ff; font-size:12px }

  /* Settings sheet */
  .sheet{
    position:fixed; left:0; right:0; bottom:-100%; background:linear-gradient(180deg,#0e1731,#0a1224);
    border-top:1px solid #1f2a44; border-radius:18px 18px 0 0; box-shadow:0 -40px 80px #000a;
    transition:bottom .28s ease; padding:16px 14px 24px; max-height:80vh; overflow:auto;
  }
  .sheet.show{ bottom:0 }
  .sheet h2{ margin:8px 6px 10px; font-size:18px }
  .set-list{ display:grid; gap:10px; padding:6px }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:10px;
        border:1px solid #1e2a41; background:#0c162c; border-radius:14px; padding:12px 14px }
  .row .k{ color:#cfe3ff; font-weight:700 }
  .row .v{ color:#9fd9ff }
  .row .badge{ font-size:11px; border:1px solid #22324a; border-radius:999px; padding:4px 8px; color:#cbd5e1; background:#0f1e33 }

  .warning{ color:var(--warn) }
  .ok{ color:var(--ok) }
  .bad{ color:var(--bad) }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex; align-items:center; gap:10px">
        <button id="gearBtn" class="gear" aria-label="Abrir configuración">⚙️</button>
        <div class="brand">SmartDrive</div>
      </div>
      <div class="clock" id="clock">--:--</div>
    </header>

    <!-- Driving screen -->
    <main class="drive">
      <div id="driveStatus" class="status">Drive.AI listo</div>

      <div id="jarvis" class="jarvis" aria-label="Tocar para hablar">
        <div class="j-core">
          <div class="j-ring"></div>
          <div class="j-pulse"></div>
          <div class="j-eq" id="jEq"></div>
        </div>
      </div>

      <div id="prompt" class="prompt">¿En qué te ayudo?</div>
      <div id="mini" class="status">Toque el anillo para hablar</div>
    </main>

    <div class="foot">
      <span id="net" class="ok">● Conectado</span>
      <span>·</span>
      <span id="loc" class="warning">Ubicación no verificada</span>
    </div>
  </div>

  <!-- Settings sheet -->
  <aside id="sheet" class="sheet" aria-modal="true" aria-hidden="true">
    <h2>Configuración</h2>
    <div class="set-list">
      <div class="row"><div class="k">General</div><div class="badge">Modo conducción</div></div>
      <div class="row"><div class="k">Navegación</div><div class="v">Maps/Apple Maps</div></div>
      <div class="row"><div class="k">Clima</div><div class="v">Open-Meteo</div></div>
      <div class="row"><div class="k">WhatsApp</div><div class="v">Enlaces wa.me</div></div>
      <div class="row"><div class="k">Voz</div><div class="v">es-AR</div></div>
      <div class="row"><div class="k">Contactos favoritos</div><div class="badge">Editar</div></div>
    </div>
  </aside>

<script>
/* ====== Clock ====== */
function tickClock(){
  const s = new Intl.DateTimeFormat('es-AR',{hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());
  document.getElementById('clock').textContent = s;
}
setInterval(tickClock, 500); tickClock();

/* ====== Jarvis visualizer ====== */
class JarvisViz {
  constructor(root){
    this.root = root; this.eq = document.getElementById('jEq'); this.timer=null; this.bars=[];
    for(let i=0;i<16;i++){ const b=document.createElement('div'); b.className='j-bar'; this.eq.appendChild(b); this.bars.push(b); }
  }
  start(){ if(this.timer) return; this.root.classList.add('speaking'); let t=0; this.timer=setInterval(()=>{ t+=0.12; for(let i=0;i<this.bars.length;i++){ const h=10+Math.abs(Math.sin(t*(0.85+i*0.035))*28)+(Math.random()*18); this.bars[i].style.height=`${Math.min(72,h)}px`; }},60); }
  stop(){ if(!this.timer) return; clearInterval(this.timer); this.timer=null; this.root.classList.remove('speaking'); this.bars.forEach(b=>b.style.height='10px'); }
}
const jarvis = new JarvisViz(document.getElementById('jarvis'));

/* ====== STT / TTS ====== */
const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recog = new Recognition();
recog.lang = "es-AR";
recog.interimResults = false;

function tts(text){
  try{ speechSynthesis.cancel(); }catch{}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "es-AR";
  u.onstart = ()=> jarvis.start();
  u.onend   = ()=> jarvis.stop();
  speechSynthesis.speak(u);
}

/* Tap ring to talk */
document.getElementById('jarvis').addEventListener('click', ()=>{
  recog.start();
  document.getElementById('driveStatus').textContent = "Escuchando…";
  jarvis.start();
});

recog.onresult = async (e)=>{
  const text = e.results[0][0].transcript;
  document.getElementById('prompt').textContent = `“${text}”`;
  document.getElementById('driveStatus').textContent = "Procesando…";

  if (maybeLocal(text)) return;

  try{
    const r = await fetch("/api/intent", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text })
    });
    const data = await r.json();
    const reply = data.reply || "Listo.";
    document.getElementById('driveStatus').textContent = "Hecho";
    tts(reply);
  }catch(err){
    document.getElementById('driveStatus').textContent = "Error de red";
    tts("Hubo un problema conectando con la inteligencia artificial.");
    console.error(err);
  }
};
recog.onend = ()=> { if(!speechSynthesis.speaking) jarvis.stop(); };
recog.onerror = ()=> { document.getElementById('driveStatus').textContent = "Micrófono no disponible"; };

/* ====== Local intents: hora, clima, ubicación ====== */
let lastWX = null, lastPlace = null;
async function getLocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("Sin geolocalización"));
    navigator.geolocation.getCurrentPosition(
      pos=>resolve(pos),
      err=>reject(err),
      { enableHighAccuracy:true, timeout:10000, maximumAge:60000 }
    );
  });
}
async function fetchWeather(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
  const r = await fetch(url); const j = await r.json(); const cw=j?.current_weather;
  let cond="Despejado", code=cw?.weathercode;
  if([1,2,3].includes(code)) cond="Parcialmente nublado";
  if([45,48].includes(code)) cond="Niebla";
  if([51,53,55,56,57].includes(code)) cond="Llovizna";
  if([61,63,65,66,67,80,81,82].includes(code)) cond="Lluvia";
  if([71,73,75,77,85,86].includes(code)) cond="Nieve";
  if([95,96,99].includes(code)) cond="Tormenta";
  return { t: Math.round(cw?.temperature ?? 0), cond };
}
async function reverseGeocode(lat, lon){
  const u = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=es`;
  const r = await fetch(u); const j = await r.json(); const p = j?.results?.[0];
  return p ? `${p.name}${p.admin1? ', '+p.admin1:''}` : `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
}

async function refreshWX(){
  try{
    const pos = await getLocation();
    const { latitude:lat, longitude:lon, speed } = pos.coords;
    lastPlace = await reverseGeocode(lat, lon);
    lastWX    = await fetchWeather(lat, lon);
    document.getElementById('loc').textContent = lastPlace;
    document.getElementById('loc').className = "ok";
    autoDriving(speed);
  }catch{
    document.getElementById('loc').textContent = "Ubicación sin permisos";
    document.getElementById('loc').className = "warning";
  }
}
refreshWX();

/* Local NLU */
function maybeLocal(text){
  const t = (text||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
  // hora
  if(/(^|\s)(que|qué)?\s*hora(\s*es)?(\s|$)/.test(t)){
    const h = new Intl.DateTimeFormat('es-AR',{hour:'2-digit',minute:'2-digit'}).format(new Date());
    tts(`Son las ${h}.`); document.getElementById('driveStatus').textContent="Hecho"; return true;
  }
  // clima
  if(t.includes('clima') || t.includes('temperatura') || t.includes('tiempo')){
    if(lastWX && lastPlace){
      tts(`${lastPlace}: ${lastWX.t} grados, ${lastWX.cond}.`);
    }else{
      tts("Actualizo el clima."); refreshWX();
    }
    document.getElementById('driveStatus').textContent="Hecho"; return true;
  }
  // ubicacion
  if(t.includes('donde estoy') || t.includes('dónde estoy') || t.includes('ubicacion') || t.includes('ubicación')){
    if(lastPlace){ tts(`Estás cerca de ${lastPlace}.`); }
    else { tts("Necesito tu ubicación."); }
    document.getElementById('driveStatus').textContent="Hecho"; return true;
  }
  return false;
}

/* ====== Driving Mode, Gear visibility & Wake Lock ====== */
let driving = false, wakeLock=null;

function setDriving(on){
  driving = !!on;
  // engranaje visible solo si NO conduces
  document.getElementById('gearBtn').classList.toggle('hidden', driving);
  document.getElementById('mini').textContent = driving ? "Modo conducción activado" : "Toque el anillo para hablar";
  if(driving) requestWakeLock(); else releaseWakeLock();
}
function autoDriving(speed){
  if(typeof speed === 'number' && speed !== null){
    // speed en m/s ~7.0 ≈ 25 km/h
    if(speed > 7 && !driving) setDriving(true);
    if(speed <= 2 && driving) setDriving(false);
  }
}
async function requestWakeLock(){
  try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); } }catch{}
}
function releaseWakeLock(){ try{ wakeLock && wakeLock.release(); wakeLock=null; }catch{} }
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && driving) requestWakeLock(); });

/* ====== Settings sheet open/close ====== */
const sheet = document.getElementById('sheet');
function openSheet(){ if(driving) return; sheet.classList.add('show'); sheet.setAttribute('aria-hidden','false'); }
function closeSheet(){ sheet.classList.remove('show'); sheet.setAttribute('aria-hidden','true'); }
document.getElementById('gearBtn').addEventListener('click', openSheet);
// cerrar por swipe-down / tap fuera
let startY=null;
sheet.addEventListener('touchstart',e=> startY=e.touches[0].clientY);
sheet.addEventListener('touchmove',e=>{ if(startY && e.touches[0].clientY - startY > 40) closeSheet(); });
sheet.addEventListener('click', e=>{ if(e.target===sheet) closeSheet(); });

/* ====== Network indicator ====== */
function net(){
  document.getElementById('net').className = navigator.onLine ? 'ok' : 'bad';
  document.getElementById('net').textContent = navigator.onLine ? '● Conectado' : '● Sin conexión';
}
window.addEventListener('online', net); window.addEventListener('offline', net); net();

</script>
</body>
</html>
